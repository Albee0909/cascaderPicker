Object.defineProperty(exports,"__esModule",{value:true});var _jsxFileName='lib/CascaderPicker.js';var _extends=Object.assign||function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var key in source){if(Object.prototype.hasOwnProperty.call(source,key)){target[key]=source[key];}}}return target;};var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor;};}();var _react=require('react');var _react2=_interopRequireDefault(_react);var _propTypes=require('prop-types');var _propTypes2=_interopRequireDefault(_propTypes);var _reactNative=require('react-native');var _area=require('./area.json');var _area2=_interopRequireDefault(_area);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}function _possibleConstructorReturn(self,call){if(!self){throw new ReferenceError("this hasn't been initialised - super() hasn't been called");}return call&&(typeof call==="object"||typeof call==="function")?call:self;}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass;}var Touchable=_reactNative.Platform.OS==='ios'?_reactNative.TouchableOpacity:_reactNative.TouchableNativeFeedback;var PIXEL_RADIO=1/_reactNative.PixelRatio.get();var SCREEN_WIDTH=_reactNative.Dimensions.get('window').width;var CascaderPicker=function(_React$Component){_inherits(CascaderPicker,_React$Component);function CascaderPicker(props){_classCallCheck(this,CascaderPicker);var _this=_possibleConstructorReturn(this,(CascaderPicker.__proto__||Object.getPrototypeOf(CascaderPicker)).call(this,props));_this._keyExtractor=function(item){return item.value;};_this._onTabLayout=function(e,index){var _e$nativeEvent$layout=e.nativeEvent.layout,width=_e$nativeEvent$layout.width,x=_e$nativeEvent$layout.x;_this.tabsOffsetMap[index]={width:width,x:x};if(index===_this.state.activeIndex){_this.activeUnderlineLeft.setValue(x);_this.activeUnderlineWidth.setValue(width);}};_this._onHorizontalScroll=function(e){var offsetX=e.nativeEvent.contentOffset.x;var activeIndex=_this.state.activeIndex;var radio=offsetX/SCREEN_WIDTH-activeIndex;var target=_this.tabsOffsetMap[activeIndex+(radio>0?1:-1)];if(!target||!_this.tabsOffsetMap[activeIndex]){return;}var _this$tabsOffsetMap$a=_this.tabsOffsetMap[activeIndex],x=_this$tabsOffsetMap$a.x,width=_this$tabsOffsetMap$a.width;if(radio>0){_this.activeUnderlineLeft.setValue(x+radio*(target.x-x));_this.activeUnderlineWidth.setValue(width+radio*(target.width-width));}else if(radio<0){_this.activeUnderlineLeft.setValue(x+radio*(x-target.x));_this.activeUnderlineWidth.setValue(width+radio*(width-target.width));}else{_this.activeUnderlineLeft.setValue(x);_this.activeUnderlineWidth.setValue(width);}};_this._onMomentumScrollEnd=function(){_this.setState({activeIndex:_this.$targetIndex});};_this._animteTo=function(index){_this._scrollTo(index);};_this._onSelectRegion=function(index,value){var values=_this.state.values.slice(0,index).concat(_extends({},value,{siblings:_this.state.values[index].siblings}));if(value.children){values=values.concat({siblings:value.children,label:'',value:''});}_this.setState({values:values},function(){if(value.children){_this._scrollTo(index+1);}else{_this.props.onCheck(values.map(function(_ref){var value=_ref.value,label=_ref.label;return{value:value,label:label};}));}});};_this.activeUnderlineLeft=new _reactNative.Animated.Value(0);_this.activeUnderlineWidth=new _reactNative.Animated.Value(0);_this.tabsOffsetMap={};var len=props.value.length;_this.state={values:_this.getValues(props),activeIndex:len===0?0:len-1};return _this;}_createClass(CascaderPicker,[{key:'getValues',value:function getValues(props){var value=props.value,data=props.data;return value.reduce(function(acc,cur,index){if(index===0){acc[0].label=cur.label;acc[0].value=cur.value;var initialScrollIndex=acc[0].siblings.findIndex(function(_ref2){var value=_ref2.value;return value===cur.value;});acc[0].initialScrollIndex=initialScrollIndex;acc[0].children=acc[0].siblings[initialScrollIndex].children;}else{var _initialScrollIndex=acc[index-1].children.findIndex(function(_ref3){var value=_ref3.value;return value===cur.value;});var item=acc[index-1].children[_initialScrollIndex];acc.push(_extends({},item,{initialScrollIndex:_initialScrollIndex,siblings:acc[index-1].children}));}return acc;},[{siblings:data,label:'',value:''}]);}},{key:'_scrollTo',value:function _scrollTo(index){var animated=arguments.length>1&&arguments[1]!==undefined?arguments[1]:true;this.$targetIndex=index;this.refs.scroller&&this.refs.scroller.scrollTo({animated:animated,x:SCREEN_WIDTH*index,y:0});}},{key:'shouldComponentUpdate',value:function shouldComponentUpdate(nextProps,nextState){return nextState.values!==this.state.values||nextState.activeIndex!==this.state.activeIndex||nextProps.value!==this.props.value;}},{key:'componentWillReceiveProps',value:function componentWillReceiveProps(nextProps){var _this2=this;if(nextProps.value!==this.props.value){var len=nextProps.value.length;this.setState({values:this.getValues(nextProps),activeIndex:len===0?0:len-1},function(v){var _tabsOffsetMap$state$=_this2.tabsOffsetMap[_this2.state.activeIndex],x=_tabsOffsetMap$state$.x,width=_tabsOffsetMap$state$.width;_this2.activeUnderlineLeft.setValue(x);_this2.activeUnderlineWidth.setValue(width);});}}},{key:'componentDidMount',value:function componentDidMount(){this._scrollTo(this.state.activeIndex,false);}},{key:'render',value:function render(){var _this3=this;var _state=this.state,values=_state.values,activeIndex=_state.activeIndex;var _props=this.props,activeColor=_props.activeColor,underlineHeight=_props.underlineHeight,containerHeight=_props.containerHeight;return _react2.default.createElement(_reactNative.View,{style:[styles.container,{height:containerHeight}],__source:{fileName:_jsxFileName,lineNumber:158}},_react2.default.createElement(_reactNative.View,{style:[styles.tabs,{borderBottomWidth:underlineHeight}],__source:{fileName:_jsxFileName,lineNumber:159}},values.map(function(_ref4,index){var label=_ref4.label,value=_ref4.value;return _react2.default.createElement(_reactNative.Animated.View,{onLayout:function onLayout(e){return _this3._onTabLayout(e,index);},key:index,__source:{fileName:_jsxFileName,lineNumber:162}},_react2.default.createElement(Touchable,{onPress:function onPress(){return _this3._animteTo(index);},__source:{fileName:_jsxFileName,lineNumber:165}},_react2.default.createElement(_reactNative.Text,{style:[styles.tabText,activeIndex===index&&{color:activeColor}],__source:{fileName:_jsxFileName,lineNumber:166}},label||'请选择')));}),_react2.default.createElement(_reactNative.Animated.View,{style:[styles.activeUnderline,{width:this.activeUnderlineWidth,left:this.activeUnderlineLeft,backgroundColor:activeColor,height:underlineHeight,bottom:-underlineHeight,position:'absolute'}],__source:{fileName:_jsxFileName,lineNumber:173}})),_react2.default.createElement(_reactNative.ScrollView,{ref:'scroller',onScroll:this._onHorizontalScroll,scrollEventThrottle:8,onMomentumScrollEnd:this._onMomentumScrollEnd,horizontal:true,pagingEnabled:true,showsHorizontalScrollIndicator:false,style:styles.content,__source:{fileName:_jsxFileName,lineNumber:185}},values.map(function(_ref5,index){var siblings=_ref5.siblings,value=_ref5.value,initialScrollIndex=_ref5.initialScrollIndex;return _react2.default.createElement(_reactNative.FlatList,{key:index,keyExtractor:_this3._keyExtractor,extraData:value,data:siblings,initialScrollIndex:initialScrollIndex,getItemLayout:function getItemLayout(item,index){return{length:siblings.length,offset:40*index,index:index};},style:styles.regions,renderItem:function renderItem(_ref6){var item=_ref6.item;var active=value===item.value;return _react2.default.createElement(Touchable,{onPress:function onPress(){return _this3._onSelectRegion(index,item);},style:styles.region,__source:{fileName:_jsxFileName,lineNumber:209}},_react2.default.createElement(_reactNative.Text,{style:[styles.regionText,active&&{color:activeColor}],__source:{fileName:_jsxFileName,lineNumber:212}},item.label+(active?'    √':'')));},__source:{fileName:_jsxFileName,lineNumber:197}});})));}}]);return CascaderPicker;}(_react2.default.Component);CascaderPicker.propTypes={onCheck:_propTypes2.default.func,value:_propTypes2.default.arrayOf(_propTypes2.default.shape({value:_propTypes2.default.string,label:_propTypes2.default.string})),data:_propTypes2.default.arrayOf(_propTypes2.default.shape({value:_propTypes2.default.string,label:_propTypes2.default.string,children:_propTypes2.default.array})).isRequired,activeColor:_propTypes2.default.string,underlineHeight:_propTypes2.default.number,containerHeight:_propTypes2.default.number};CascaderPicker.defaultProps={onCheck:function onCheck(){},value:[],data:_area2.default,activeColor:'#FF7F24',underlineHeight:4*PIXEL_RADIO,containerHeight:400};exports.default=CascaderPicker;var styles=_reactNative.StyleSheet.create({container:{width:SCREEN_WIDTH},tabs:{borderBottomColor:'#ccc',flexDirection:'row',width:SCREEN_WIDTH},tabText:{marginHorizontal:14,paddingVertical:14},content:{flex:1,width:SCREEN_WIDTH},regions:{width:SCREEN_WIDTH,flex:1,paddingLeft:10},region:{height:40},regionText:{lineHeight:40}});